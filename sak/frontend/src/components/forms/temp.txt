"use client";

import { useEffect, useMemo, useState } from "react";
import { Controller, FormProvider, useForm, useWatch } from "react-hook-form";
import { useNotify, useRefresh, useGetIdentity, useDataProvider } from "ra-core";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Checkbox } from "@/components/ui/checkbox";
import { ComboboxQuery, FormWizard } from "@/components/forms";
import { MessagePreview, SectionCard, SummaryList } from "@/components/forms/form-wizard/sections";
import type { CRMMensaje, FormValues, OportunidadAuto } from "./model";
import {
  CONTACTO_REFERENCE,
  ESTADO_OPORTUNIDAD_CHOICES,
  MOTIVOS_EVENTO_REFERENCE,
  OPORTUNIDADES_REFERENCE,
  PROPIEDADES_REFERENCE,
  TIPOS_EVENTO_REFERENCE,
  TIPOS_OPERACION_REFERENCE,
  USERS_REFERENCE,
  buildConfirmPayload,
  getContactoValidationError,
  getOportunidadSummaryData,
  getOportunidadValidationError,
  getDefaultFormValues,
  getRespuestaSummaryData,
} from "./model";

const API_URL = process.env.NEXT_PUBLIC_API_URL ?? "http://localhost:8000";

export const CRMInboxConfirmForm = ({
  message,
  onSuccess,
  onCancel,
}: {
  message: CRMMensaje;
  onSuccess?: () => void;
  onCancel?: () => void;
}) => {
  const { data: identity } = useGetIdentity();

  const methods = useForm<FormValues>({
    defaultValues: getDefaultFormValues(message, identity),
    shouldUnregister: false,
  });

  const notify = useNotify();
  const refresh = useRefresh();
  const dataProvider = useDataProvider();
  const [forceNuevaOportunidad, setForceNuevaOportunidad] = useState(false);
const [autoOportunidad, setAutoOportunidad] = useState<OportunidadAuto | null>(null);
  const [loadingContacto, setLoadingContacto] = useState(false);
  const [tipoOperacionLabel, setTipoOperacionLabel] = useState<string>("");
  const [responsableLabel, setResponsableLabel] = useState<string>("");
  const [eventoTipoDefault, setEventoTipoDefault] = useState<string>("");
  const [propiedadNombre, setPropiedadNombre] = useState<string>("");

  useEffect(() => {
    methods.reset(getDefaultFormValues(message, identity));
    setAutoOportunidad(null);
    setForceNuevaOportunidad(false);
  }, [message, identity, methods]);
  useEffect(() => {
    methods.register("contacto_referencia");
  }, [methods]);

  useEffect(() => {
    let unsubscribed = false;
    const fetchEventoTipos = async () => {
      try {
        const { data } = await dataProvider.getList("crm/catalogos/tipos-evento", {
          pagination: { page: 1, perPage: 50 },
          sort: { field: "nombre", order: "ASC" },
          filter: {},
        });
        if (!unsubscribed && Array.isArray(data) && data.length > 0) {
          const match =
            data.find((item: any) => item.codigo === message.tipo) ??
            data.find((item: any) => item.tipo === message.tipo) ??
            data[0];
          if (match) {
            setEventoTipoDefault(String(match.id));
          }
        }
      } catch {
        // ignore
      }
    };
    fetchEventoTipos();
    return () => {
      unsubscribed = true;
    };
  }, [dataProvider, message.tipo]);

  useEffect(() => {
    if (eventoTipoDefault) {
      methods.setValue("evento_tipo_id", eventoTipoDefault, { shouldDirty: false });
    }
  }, [eventoTipoDefault, methods]);

  const contactoNuevo = useWatch({ control: methods.control, name: "contacto_nuevo" }) ?? false;
  const crearOportunidad = useWatch({ control: methods.control, name: "crear_oportunidad" }) ?? false;
  const contactoId = useWatch({ control: methods.control, name: "contacto_id" });
  const contactoNombre = useWatch({ control: methods.control, name: "contacto_nombre" }) ?? "";
const contactoResponsableId = useWatch({ control: methods.control, name: "contacto_responsable_id" });
const referenciaValor =
  useWatch({ control: methods.control, name: "contacto_referencia" }) ?? message.contacto_referencia ?? "";
const oportunidadId = useWatch({ control: methods.control, name: "oportunidad_id" });
const propiedadId = useWatch({ control: methods.control, name: "propiedad_id" });
const tipoOperacionId = useWatch({ control: methods.control, name: "tipo_operacion_id" });
const responsableOportunidadId = useWatch({
  control: methods.control,
  name: "responsable_oportunidad_id",
});
const eventoTipoId = useWatch({ control: methods.control, name: "evento_tipo_id" });
const eventoMotivoId = useWatch({ control: methods.control, name: "evento_motivo_id" });
const eventoAsignadoId = useWatch({ control: methods.control, name: "evento_asignado_id" });
const eventoDescripcion = useWatch({ control: methods.control, name: "evento_descripcion" }) ?? "";
  const [currentStep, setCurrentStep] = useState(0);

  const propiedadFilter = useMemo(
    () =>
      crearOportunidad && tipoOperacionId
        ? { tipo_operacion_id: Number(tipoOperacionId) }
        : undefined,
    [crearOportunidad, tipoOperacionId]
  );

  const oportunidadFilter = useMemo(
    () =>
      !crearOportunidad && !contactoNuevo && contactoId
        ? { contacto_id: Number(contactoId), estado: "1-abierta" }
        : undefined,
    [crearOportunidad, contactoNuevo, contactoId]
  );

  const puedeElegirPropiedad = crearOportunidad && Boolean(tipoOperacionId);
  const puedeElegirOportunidad = Boolean(oportunidadFilter);
  const eventoMotivoFilter = useMemo(
    () => (eventoTipoId ? { tipo_evento_id: Number(eventoTipoId) } : undefined),
    [eventoTipoId]
  );
  const puedeElegirMotivo = Boolean(eventoMotivoFilter);

  useEffect(() => {
    if (crearOportunidad) {
      methods.setValue("proximo_estado", "1-abierta", { shouldDirty: false });
    }
  }, [crearOportunidad, methods]);

  useEffect(() => {
    if (!eventoMotivoFilter) {
      methods.setValue("evento_motivo_id", "", { shouldDirty: false });
    }
  }, [eventoMotivoFilter, methods]);

  useEffect(() => {
    const watchedPropiedadId = methods.watch("propiedad_id");
    const targetPropertyId =
      watchedPropiedadId && watchedPropiedadId.trim().length > 0
        ? watchedPropiedadId
        : !crearOportunidad && autoOportunidad?.propiedad_id
          ? String(autoOportunidad.propiedad_id)
          : "";
    if (!targetPropertyId) {
      setPropiedadNombre(autoOportunidad?.propiedad_nombre || "");
      return;
    }
    if (!crearOportunidad && autoOportunidad?.propiedad_nombre) {
      setPropiedadNombre(autoOportunidad.propiedad_nombre);
      return;
    }
    let ignore = false;
    const fetchPropiedad = async () => {
      try {
        const { data } = await dataProvider.getOne("propiedades", { id: Number(targetPropertyId) });
        if (!ignore) {
          setPropiedadNombre(data?.nombre || `Propiedad ${targetPropertyId}`);
        }
      } catch {
        if (!ignore) {
          setPropiedadNombre(`Propiedad ${targetPropertyId}`);
        }
      }
    };
    fetchPropiedad();
    return () => {
      ignore = true;
    };
  }, [methods, autoOportunidad?.propiedad_id, autoOportunidad?.propiedad_nombre, crearOportunidad, dataProvider]);

  const handleStepValidate = async (index: number) => {
    const values = methods.getValues();
    if (index === 0) {
      const error = getContactoValidationError(values);
      if (error) {
        notify(error, { type: "warning" });
        return false;
      }
    }
    if (index === 1) {
      const error = getOportunidadValidationError(values);
      if (error) {
        notify(error, { type: "warning" });
        return false;
      }
    }
    return true;
  };

  useEffect(() => {
    if (contactoNuevo) {
      methods.setValue("contacto_id", undefined);
      methods.setValue("oportunidad_id", undefined);
      methods.setValue("tipo_operacion_id", "");
      methods.setValue("propiedad_id", "");
      setAutoOportunidad(null);
      setForceNuevaOportunidad(true);
      methods.setValue("crear_oportunidad", true);
      return;
    }
    if (!contactoId) {
      setAutoOportunidad(null);
      setForceNuevaOportunidad(false);
      return;
    }
    let ignore = false;
    const fetchContactoData = async () => {
      try {
        setLoadingContacto(true);
        const contactoNumeric = Number(contactoId);
        const { data: contacto } = await dataProvider.getOne("crm/contactos", { id: contactoNumeric });
        if (!ignore && contacto?.nombre_completo) {
          methods.setValue("contacto_nombre", contacto.nombre_completo, { shouldDirty: false });
        }
        const { data: oportunidades } = await dataProvider.getList("crm/oportunidades", {
          pagination: { page: 1, perPage: 1 },
          sort: { field: "created_at", order: "DESC" },
          filter: { contacto_id: contactoNumeric, estado: "1-abierta" },
        });
        if (ignore) {
          return;
        }
        if (Array.isArray(oportunidades) && oportunidades.length > 0) {
          const abierta = oportunidades[0];
          setAutoOportunidad({
            id: abierta.id,
            label: abierta.descripcion_estado || `Oportunidad #${abierta.id}`,
            propiedad_id: abierta.propiedad_id,
            tipo_operacion_id: abierta.tipo_operacion_id,
            responsable_id: abierta.responsable_id,
            tipo_operacion_nombre: abierta.tipo_operacion?.nombre,
            responsable_nombre: abierta.responsable?.nombre,
            propiedad_nombre: abierta.propiedad?.nombre,
            estado: abierta.estado,
          });
          setForceNuevaOportunidad(false);
          methods.setValue("crear_oportunidad", false, { shouldDirty: true });
          methods.setValue("oportunidad_id", String(abierta.id), { shouldDirty: true });
          methods.setValue("tipo_operacion_id", abierta.tipo_operacion_id ? String(abierta.tipo_operacion_id) : "", {
            shouldDirty: false,
          });
          methods.setValue("propiedad_id", abierta.propiedad_id ? String(abierta.propiedad_id) : "", {
            shouldDirty: false,
          });
          methods.setValue("proximo_estado", abierta.estado || "", { shouldDirty: false });
        } else {
          setAutoOportunidad(null);
          setForceNuevaOportunidad(true);
          methods.setValue("crear_oportunidad", true);
          methods.setValue("oportunidad_id", undefined);
          methods.setValue("tipo_operacion_id", "");
          methods.setValue("propiedad_id", "");
          methods.setValue("proximo_estado", "", { shouldDirty: false });
        }
      } catch {
        if (!ignore) {
          notify("No se pudo obtener datos del contacto", { type: "warning" });
          setForceNuevaOportunidad(false);
        }
      } finally {
        if (!ignore) {
          setLoadingContacto(false);
        }
      }
    };
    fetchContactoData();
    return () => {
      ignore = true;
    };
  }, [contactoId, contactoNuevo, dataProvider, methods, notify]);

  useEffect(() => {
    if (crearOportunidad) {
      methods.setValue("oportunidad_id", undefined);
      setAutoOportunidad(null);
    }
  }, [crearOportunidad, methods]);

  useEffect(() => {
    if (!crearOportunidad && oportunidadId) {
      let ignore = false;
      const loadOportunidad = async () => {
        try {
          const numericId = Number(oportunidadId);
          if (autoOportunidad && autoOportunidad.id === numericId) {
            return;
          }
          const { data } = await dataProvider.getOne("crm/oportunidades", { id: numericId });
          if (!ignore && data) {
            setAutoOportunidad({
              id: data.id,
              label: data.descripcion_estado || `Oportunidad #${data.id}`,
              propiedad_id: data.propiedad_id,
              tipo_operacion_id: data.tipo_operacion_id,
            responsable_id: data.responsable_id,
            tipo_operacion_nombre: data.tipo_operacion?.nombre,
            responsable_nombre: data.responsable?.nombre,
            propiedad_nombre: data.propiedad?.nombre,
            estado: data.estado,
          });
            methods.setValue("tipo_operacion_id", data.tipo_operacion_id ? String(data.tipo_operacion_id) : "", {
              shouldDirty: false,
            });
            methods.setValue("propiedad_id", data.propiedad_id ? String(data.propiedad_id) : "", {
              shouldDirty: false,
            });
            methods.setValue("proximo_estado", data.estado || "", { shouldDirty: false });
          }
        } catch {
          if (!ignore) {
            notify("No se pudo cargar la oportunidad seleccionada", { type: "warning" });
          }
        }
      };
      loadOportunidad();
      return () => {
        ignore = true;
      };
    }
  }, [crearOportunidad, oportunidadId, autoOportunidad, dataProvider, notify, methods]);

  const submit = async () => {
    try {
      const values = methods.getValues();
      const payload = buildConfirmPayload(values);

      const token = typeof window !== "undefined" ? localStorage.getItem("auth_token") : null;
      const res = await fetch(`${API_URL}/crm/mensajes/${message.id}/confirmar`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          ...(token ? { Authorization: `Bearer ${token}` } : {}),
        },
        body: JSON.stringify(payload),
      });
      if (!res.ok) {
        const txt = await res.text();
        throw new Error(txt || `HTTP ${res.status}`);
      }
      notify("Mensaje confirmado", { type: "info" });
      onSuccess?.();
      refresh();
    } catch (e: any) {
      notify(e?.message || "No se pudo confirmar", { type: "warning" });
    }
  };

  const oportunidadSummary = useMemo(
    () => (
      <SummaryList
        items={getOportunidadSummaryData({
          crearOportunidad,
          values: {
            propiedad_id: propiedadId,
            tipo_operacion_id: tipoOperacionId,
            responsable_oportunidad_id: responsableOportunidadId,
            oportunidad_id: oportunidadId,
          },
          autoOportunidad,
        })}
      />
    ),
    [crearOportunidad, propiedadId, tipoOperacionId, responsableOportunidadId, autoOportunidad, oportunidadId]
  );

  const respuestaSummary = useMemo(
    () => (
      <SummaryList
        items={getRespuestaSummaryData({
          contacto_responsable_id: contactoResponsableId,
          evento_tipo_id: eventoTipoId,
          evento_motivo_id: eventoMotivoId,
          evento_asignado_id: eventoAsignadoId,
          evento_descripcion: eventoDescripcion,
        })}
      />
    ),
    [contactoResponsableId, eventoTipoId, eventoMotivoId, eventoAsignadoId, eventoDescripcion]
  );

  useEffect(() => {
    const targetTipoId = crearOportunidad
      ? tipoOperacionId
      : autoOportunidad?.tipo_operacion_id
        ? String(autoOportunidad.tipo_operacion_id)
        : tipoOperacionId;
    if (!targetTipoId) {
      setTipoOperacionLabel("");
      return;
    }

    if (!crearOportunidad && autoOportunidad?.tipo_operacion_nombre) {
      setTipoOperacionLabel(autoOportunidad.tipo_operacion_nombre);
      return;
    }

    let ignore = false;
    const fetchTipo = async () => {
      try {
        const { data } = await dataProvider.getOne("crm/catalogos/tipos-operacion", {
          id: Number(targetTipoId),
        });
        if (!ignore) {
          setTipoOperacionLabel(data?.nombre || `Tipo ${targetTipoId}`);
        }
      } catch {
        if (!ignore) {
          setTipoOperacionLabel(`Tipo ${targetTipoId}`);
        }
      }
    };
    fetchTipo();
    return () => {
      ignore = true;
    };
  }, [crearOportunidad, tipoOperacionId, autoOportunidad?.tipo_operacion_id, autoOportunidad?.tipo_operacion_nombre, dataProvider]);

  useEffect(() => {
    const targetResponsableId = crearOportunidad
      ? responsableOportunidadId
      : autoOportunidad?.responsable_id
        ? String(autoOportunidad.responsable_id)
        : undefined;
    if (!targetResponsableId) {
      setResponsableLabel("");
      return;
    }
    if (!crearOportunidad && autoOportunidad?.responsable_nombre) {
      setResponsableLabel(autoOportunidad.responsable_nombre);
      return;
    }
    let ignore = false;
    const fetchResponsable = async () => {
      try {
        const { data } = await dataProvider.getOne("users", { id: Number(targetResponsableId) });
        if (!ignore) {
          setResponsableLabel(data?.nombre || `ID ${targetResponsableId}`);
        }
      } catch {
        if (!ignore) {
          setResponsableLabel(`ID ${targetResponsableId}`);
        }
      }
    };
    fetchResponsable();
    return () => {
      ignore = true;
    };
  }, [crearOportunidad, responsableOportunidadId, autoOportunidad?.responsable_id, autoOportunidad?.responsable_nombre, dataProvider]);

  const resumenOportunidadTexto = useMemo(() => {
    const resolvedPropiedadNombre =
      propiedadNombre ||
      autoOportunidad?.propiedad_nombre ||
      (autoOportunidad?.propiedad_id ? `Propiedad ${autoOportunidad.propiedad_id}` : undefined) ||
      (propiedadId && propiedadId.trim().length > 0 ? `Propiedad ${propiedadId}` : undefined);
    const tipoTexto = tipoOperacionLabel || (tipoOperacionId ? `Tipo ${tipoOperacionId}` : undefined);
    if (crearOportunidad) {
      const propiedadTexto = resolvedPropiedadNombre || (propiedadId ? `Propiedad ${propiedadId}` : "Propiedad sin asignar");
      return [tipoTexto, propiedadTexto].filter(Boolean).join(" - ");
    }
    if (autoOportunidad) {
      const propiedadTexto = resolvedPropiedadNombre || autoOportunidad.label;
      return [tipoOperacionLabel, propiedadTexto].filter(Boolean).join(" - ");
    }
    if (oportunidadId) {
      return [tipoOperacionLabel, `Oportunidad #${oportunidadId}`].filter(Boolean).join(" - ");
    }
    return tipoOperacionLabel || undefined;
  }, [crearOportunidad, tipoOperacionLabel, propiedadNombre, autoOportunidad, oportunidadId, tipoOperacionId, propiedadId]);

  const responsableTexto = useMemo(() => {
    if ((crearOportunidad && responsableOportunidadId) || (!crearOportunidad && autoOportunidad?.responsable_id)) {
      return responsableLabel;
    }
    return responsableLabel || undefined;
  }, [crearOportunidad, responsableOportunidadId, autoOportunidad, responsableLabel]);

  const contactoPreviewNombre = useMemo(() => {
    return contactoNuevo
      ? `${contactoNombre.trim() || "(sin nombre)"} (nuevo)`
      : contactoNombre || (contactoId ? `ID ${contactoId}` : undefined);
  }, [contactoNuevo, contactoNombre, contactoId]);

  const oportunidadPreviewLabel = crearOportunidad
    ? `${resumenOportunidadTexto || "Nueva oportunidad"} (nuevo)`
    : resumenOportunidadTexto;

  const propiedadPreviewLabel = useMemo(() => {
    const resolved =
      propiedadNombre ||
      autoOportunidad?.propiedad_nombre ||
      (autoOportunidad?.propiedad_id ? `Propiedad ${autoOportunidad.propiedad_id}` : undefined) ||
      (propiedadId && propiedadId.trim().length > 0 ? `Propiedad ${propiedadId}` : undefined);
    if (!resolved) {
      return crearOportunidad ? "Propiedad sin asignar" : undefined;
    }
    return resolved;
  }, [propiedadNombre, autoOportunidad?.propiedad_nombre, autoOportunidad?.propiedad_id, propiedadId, crearOportunidad]);

  const messageBlock = (
    <MessagePreview
      referencia={referenciaValor || message.contacto_referencia || ""}
      asunto={message.asunto}
      contenido={message.contenido}
      contactName={contactoPreviewNombre}
      resumenOportunidad={oportunidadPreviewLabel}
      propiedadLabel={propiedadPreviewLabel}
      responsableTexto={responsableTexto}
    />
  );

  const steps = [
    {
      title: "Contacto",
      content: (
        <div className="space-y-4">
          {messageBlock}
          <SectionCard
            title="Contacto"
            active={currentStep === 0}
            action={
              <Controller
                name="contacto_nuevo"
                control={methods.control}
                defaultValue={false}
                render={({ field }) => (
                  <label className="flex items-center gap-2 text-sm">
                    <span className="text-xs uppercase tracking-wide text-muted-foreground">Nuevo</span>
                    <Checkbox
                      checked={!!field.value}
                      onCheckedChange={(checked) => field.onChange(Boolean(checked))}
                    />
                  </label>
                )}
              />
            }
          >
            <div className="space-y-2">
              {contactoNuevo ? (
                <Input
                  placeholder="Nombre"
                  {...methods.register("contacto_nombre")}
                  className="flex-1 min-w-0"
                />
              ) : (
                <ComboboxQuery
                  {...CONTACTO_REFERENCE}
                  source="contacto_id"
                  placeholder="Buscar contacto"
                  disabled={loadingContacto}
                />
              )}
            </div>
          </SectionCard>
          <SectionCard title="Oportunidad" collapsible defaultCollapsed>
            {oportunidadSummary}
          </SectionCard>
          <SectionCard title="Respuesta" collapsible defaultCollapsed>
            {respuestaSummary}
          </SectionCard>
        </div>
      ),
    },
    {
      title: "Oportunidad",
      content: (
        <div className="space-y-4">
          {messageBlock}
          <SectionCard
            title="Oportunidad"
            active={currentStep === 1}
            action={
              <Controller
                name="crear_oportunidad"
                control={methods.control}
                render={({ field }) => (
                  <label className="flex items-center gap-2 text-sm whitespace-nowrap">
                    Nueva
                    <Checkbox
                      checked={!!field.value}
                      onCheckedChange={(checked) => field.onChange(Boolean(checked))}
                      disabled={forceNuevaOportunidad}
                    />
                  </label>
                )}
              />
            }
          >
            <div className="space-y-3">
              <div className="grid gap-2 sm:grid-cols-[0.7fr_1fr]">
                <ComboboxQuery
                  {...TIPOS_OPERACION_REFERENCE}
                  source="tipo_operacion_id"
                  placeholder="Tipo de operaci칩n"
                  disabled={!crearOportunidad}
                  enabled={crearOportunidad}
                />
                <ComboboxQuery
                  {...PROPIEDADES_REFERENCE}
                  source="propiedad_id"
                  placeholder={tipoOperacionId ? "Propiedad" : "Selecciona tipo"}
                  disabled={!puedeElegirPropiedad}
                  filter={propiedadFilter}
                  dependsOn={`${tipoOperacionId ?? "none"}-${crearOportunidad}`}
                  enabled={puedeElegirPropiedad}
                />
              </div>
              <div className="space-y-1">
                <p className="text-xs uppercase text-muted-foreground font-medium">Oportunidad existente</p>
                <ComboboxQuery
                  {...OPORTUNIDADES_REFERENCE}
                  source="oportunidad_id"
                  placeholder="Selecciona una oportunidad"
                  disabled={!puedeElegirOportunidad}
                  filter={oportunidadFilter}
                  dependsOn={`${contactoId ?? "none"}-${crearOportunidad}-${contactoNuevo}`}
                  enabled={puedeElegirOportunidad}
                />
              </div>
              {crearOportunidad ? (
                <div className="space-y-1">
                  <p className="text-xs uppercase text-muted-foreground font-medium">Responsable</p>
                  <ComboboxQuery
                    {...USERS_REFERENCE}
                    source="responsable_oportunidad_id"
                    placeholder="Selecciona responsable"
                    disabled={!crearOportunidad}
                    enabled={crearOportunidad}
                  />
                </div>
              ) : (
                <p className="text-xs text-muted-foreground">
                  Se vincular치 con la oportunidad existente seleccionada.
                </p>
              )}
            </div>
          </SectionCard>
          <SectionCard title="Respuesta" collapsible defaultCollapsed>
            {respuestaSummary}
          </SectionCard>
        </div>
      ),
    },
    {
      title: "Evento / respuesta",
      content: (
        <div className="space-y-4">
          {messageBlock}
          <SectionCard title="Respuesta" collapsible active={currentStep === 2}>
            <div className="grid gap-3 sm:grid-cols-2">
              <div className="space-y-1">
                <p className="text-xs uppercase text-muted-foreground font-medium">Tipo de evento</p>
                <ComboboxQuery
                  {...TIPOS_EVENTO_REFERENCE}
                  source="evento_tipo_id"
                  placeholder="Selecciona tipo"
                />
              </div>
              <div className="space-y-1">
                <p className="text-xs uppercase text-muted-foreground font-medium">Motivo</p>
                <ComboboxQuery
                  {...MOTIVOS_EVENTO_REFERENCE}
                  source="evento_motivo_id"
                  placeholder="Selecciona motivo"
                  filter={eventoMotivoFilter}
                  dependsOn={eventoTipoId ?? "none"}
                  disabled={!puedeElegirMotivo}
                  enabled={puedeElegirMotivo}
                />
              </div>
            </div>
            <div className="grid gap-3 sm:grid-cols-2">
              <div className="space-y-1">
                <p className="text-xs uppercase text-muted-foreground font-medium">Pr칩ximo estado</p>
                <select
                  className="w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                  {...methods.register("proximo_estado")}
                  disabled={crearOportunidad}
                >
                  {ESTADO_OPORTUNIDAD_CHOICES.map((choice) => (
                    <option key={choice.id} value={choice.id}>
                      {choice.name}
                    </option>
                  ))}
                </select>
              </div>
              <div className="space-y-1">
                <p className="text-xs uppercase text-muted-foreground font-medium">Fecha compromiso</p>
                <Input type="date" {...methods.register("fecha_proximo_estado")} />
              </div>
            </div>
            <div className="space-y-1">
              <p className="text-xs uppercase text-muted-foreground font-medium">Asignado a</p>
              <ComboboxQuery
                {...USERS_REFERENCE}
                source="evento_asignado_id"
                placeholder="Selecciona responsable"
              />
            </div>
            <div className="space-y-1">
              <div className="flex items-center justify-between">
                <p className="text-xs uppercase text-muted-foreground font-medium">Respuesta</p>
                <label className="flex items-center gap-2 text-sm">
                  <Checkbox
                    checked={methods.watch("enviar_respuesta")}
                    onCheckedChange={(checked) => methods.setValue("enviar_respuesta", Boolean(checked))}
                  />
                  Enviar
                </label>
              </div>
              <Textarea
                rows={4}
                {...methods.register("evento_descripcion")}
                placeholder="Detalle la respuesta o acci칩n"
              />
            </div>
          </SectionCard>
        </div>
      ),
    },
  ];

  return (
    <FormProvider {...methods}>
      <FormWizard
        steps={steps}
        finishLabel="Confirmar"
        onFinish={submit}
        onStepChange={setCurrentStep}
        onStepValidate={handleStepValidate}
        className="max-h-[70vh] overflow-y-auto pr-2"
      />
      <div className="mt-4 flex justify-end">
        <Button variant="outline" onClick={onCancel}>
          Cancelar
        </Button>
      </div>
    </FormProvider>
  );
};
